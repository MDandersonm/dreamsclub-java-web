<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="xyz.dreams.mapper.CartMapper">
	
  <!-- <resultMap id="cartResult" type="CartVO">
    <result property="memberId" column="member_id"/>
    <result property="goodsCode" column="goods_code"/>
    <result property="cartId" column="cart_id"/>
    <result property="cartGoodsQty" column="cart_goods_qty"/>
    <result property="cartRegDate" column="cart_reg_date"/>
  </resultMap>
  
  <resultMap id="goodsResult" type="GoodsDTO">
    <result property="goodsCode" column="goods_code"/>
    <result property="goodsPrice" column="goods_price"/>
    <result property="goodsInfo" column="goods_info"/>
    <result property="goodsYn" column="goods_yn"/>
    <result property="goodsStock" column="goods_stock"/>
    <result property="goodsImage" column="goods_image"/>
    <result property="reviewCount" column="review_count"/>
    <result property="goodsStar" column="goods_star"/>
    <result property="goodsYnL" column="goods_yn_l"/>
    <result property="goodsYnM" column="goods_yn_m"/>
    <result property="goodsYnS" column="goods_yn_s"/>
    <result property="goodsYnF" column="goods_yn_f"/>
    <result property="goodsStockL" column="goods_stock_l"/>
    <result property="goodsStockM" column="goods_stock_m"/>
    <result property="goodsStockS" column="goods_stock_s"/>
    <result property="goodsStockF" column="goods_stock_f"/>
    <result property="noSpaceGoodsCode" column="no_space_goods_code"/>
    <result property="goodsName" column="goods_name"/>
    <result property="goodsCount" column="goods_count"/>
    <result property="goodsCategory" column="goods_category"/>
    <result property="goodsSize" column="goods_size"/>
</resultMap> -->


    <!-- 형섭(수정): 2023/09/11, 회원 아이디로 장바구니 정보 조회 -->
    <!-- <select id="selectCartList" resultType="cartVO">
          SELECT * FROM tbl_cart WHERE member_id = #{memberId}
    </select> -->
    
    
    <!-- 형섭(수정): 2023/09/11, 장바구니의 정보를 가져오는 쿼리.
    foreach: 리스트를 변수로 받아와서 동적인 기능 수행하게 해줌.
    foreach문을 이용해 목록(collection)에서 각 항목(item)을 반복하며 SQL을 생성하는 쿼리. 
    => 'getMyCartGoodsCode'로 가져온 굿즈 id들의 list를 변수로 받아와서 결과값을
    'getMyCartList'에 하나씩 저장 >> "(item1,item2...)"의 형태.  
   -->
  <select id="selectGoodsList" resultType="GoodsDTO">
      SELECT * FROM goods WHERE goods_code IN
      <foreach collection="list" item="item" open="(" separator="," close=")">
        #{item.goodsCode}
      </foreach>
      ORDER BY goods_code 
  </select>
    
  
	<!-- 형섭(수정): 2023/09/11, 장바구니에 추가된 상품인지 검색하는 쿼리.
		decode(count(*), 0, 'false', 'true'): 
		count(*) : tbl_cart 테이블에서 조건을 만족하는 행의 수를 반환.
		tbl_cart 테이블에서 'goods_code'와 'member_id' 조건으로 검색하여 
		행의 수가 0이면 'false' 반환, 아니면 'true' 반환 
	-->
	<select id="findCartGoods" resultType="String" parameterType="cartVO">
      SELECT decode(count(*), 0, 'false', 'true') FROM tbl_cart 
  		WHERE goods_code = #{goodsCode}
  		AND member_id = #{memberId}
	</select>
	
	
	<!-- 형섭(수정): 2023/09/12, 장바구니에 상품 추가 쿼리.
		insert: useGeneratedKeys 속성을 이용하여 자동 생성된 키를 사용하여 cartId에 부여,
		selectKey: 자동 생성된 키를 반환. keyProperty 가 insert의 것과 동일해야 함.
		order 속성을 BEFORE로 변경하여 시퀀스 값을 가져오는 SELECT 문이 INSERT 문 실행 전에 실행.
    INSERT INTO 문에서 cart_id_seq.NEXTVAL을 직접 사용하여 cart_id 값을 설정.
	 -->
  <insert id="addGoodsInCart" useGeneratedKeys="true" keyProperty="cartId">
    <selectKey keyProperty="cartId" resultType="java.lang.Integer" order="BEFORE">
          SELECT cart_id_seq.NEXTVAL FROM dual
      </selectKey>
      INSERT INTO tbl_cart(cart_id, member_id, goods_code, goods_count)
      VALUES (#{cartId}, #{memberId}, #{goodsCode}, #{goodsCount})
  </insert>
  
  
  <update id="modifyGoodsQty" parameterType="cartVO">
        UPDATE tbl_cart
          SET goods_count = #{goodsCount}
          WHERE member_id = #{memberId}
          AND goods_code = #{goodsCode}
  </update>
  
  <delete id="delFromCart">
    DELETE FROM tbl_cart WHERE member_id = #{memberId} AND goods_code = #{goodsCode}
  </delete>
  
  <select id="selectCartList" resultType="CartVO">
    SELECT t.CART_ID, t.MEMBER_ID, t.GOODS_CODE, t.GOODS_COUNT, g.GOODS_PRICE, g.GOODS_INFO, g.GOODS_IMAGE
      FROM tbl_cart t JOIN GOODS g
        ON t.GOODS_CODE = g.GOODS_CODE
          WHERE member_id = #{memberId}
  </select>
	
</mapper>
